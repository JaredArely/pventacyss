import psycopg2
from psycopg2.extras import RealDictCursor
from flask import Flask, render_template, request, jsonify, send_from_directory
from sincronizador import buscar_global_syscom
from fpdf import FPDF
import datetime
import requests
import re
import urllib.parse 
import json
import os
import math # <--- NUEVO: Para el redondeo matemático

app = Flask(__name__)

# ==========================================
# 1. CONFIGURACIÓN GLOBAL
# ==========================================
MARGEN_PUBLICO = 0.75
MARGEN_PREFERENTE = 0.80
MARGEN_INTEGRADOR = 0.90
TIPO_CAMBIO_DOLAR = 19.00

# Ruta interna en Docker para la carpeta compartida en red
RUTA_RED_DOCKER = "/mnt/carpetacompartida" 

# ==========================================
# 2. GESTIÓN DE BASE DE DATOS (AUTO-REPARACIÓN V12)
# ==========================================
def get_db_connection():
    try:
        # Intenta conectar al host 'db' (Docker), si falla usa 'localhost' (Local)
        # Esto hace tu código compatible con ambos entornos.
        db_host = os.environ.get('DB_HOST', 'db')
        conn = psycopg2.connect(
            host=db_host,
            database="pos_sistema",
            user="postgres",
            password="Cyss2017",
            port="5432"
        )
        return conn
    except Exception as e:
        # Fallback silencioso por si estás probando localmente sin env vars
        try:
            conn = psycopg2.connect(host="localhost", database="pos_sistema", user="postgres", password="Cyss2017", port="5432")
            return conn
        except:
            print(f"Error Crítico BD: {e}")
            return None

def reparar_base_datos():
    """Crea y REPARA automáticamente la estructura de la base de datos."""
    conn = get_db_connection()
    if conn:
        try:
            cur = conn.cursor()
            conn.autocommit = True
            
            # --- TABLAS ORIGINALES ---
            cur.execute("""
                CREATE TABLE IF NOT EXISTS inventario_sucursal (
                    id SERIAL PRIMARY KEY,
                    modelo VARCHAR(50) UNIQUE,
                    nombre TEXT,
                    proveedor VARCHAR(50),
                    categoria VARCHAR(50),
                    precio DECIMAL(10,2) DEFAULT 0.00,
                    stock INTEGER DEFAULT 0,
                    moneda VARCHAR(10) DEFAULT 'MXN'
                );
            """)
            cur.execute("""CREATE TABLE IF NOT EXISTS salidas_tecnicas (
                id SERIAL PRIMARY KEY, folio SERIAL, tecnicos TEXT, 
                fecha TIMESTAMP DEFAULT NOW(), items JSONB, 
                estado VARCHAR(20) DEFAULT 'PENDIENTE', observaciones TEXT, 
                bobinas JSONB DEFAULT '[]');""")
            cur.execute("""CREATE TABLE IF NOT EXISTS ventas (
                id SERIAL PRIMARY KEY, folio SERIAL, fecha TIMESTAMP DEFAULT NOW(), 
                cliente TEXT, total DECIMAL(10,2), items JSONB, vendedor TEXT);""")
            cur.execute("""CREATE TABLE IF NOT EXISTS movimientos_inventario (
                id SERIAL PRIMARY KEY, modelo VARCHAR(50), tipo VARCHAR(20), 
                cantidad INTEGER, motivo TEXT, fecha TIMESTAMP DEFAULT NOW());""")

            # --- NUEVAS TABLAS (ACTUALIZACIÓN 2025) ---
            # 1. Órdenes de Trabajo (Técnicos)
            cur.execute("""
                CREATE TABLE IF NOT EXISTS ordenes_trabajo (
                    folio SERIAL PRIMARY KEY,
                    cliente VARCHAR(100),
                    equipo VARCHAR(100),
                    falla_reportada TEXT,
                    diagnostico TEXT,
                    trabajo_realizado TEXT,
                    costo DECIMAL(10,2),
                    estado VARCHAR(20) DEFAULT 'RECIBIDO',
                    fecha_recepcion TIMESTAMP DEFAULT NOW(),
                    fecha_entrega TIMESTAMP
                );
            """)
            # 2. Transferencias entre almacenes
            cur.execute("""
                CREATE TABLE IF NOT EXISTS transferencias (
                    id SERIAL PRIMARY KEY,
                    modelo VARCHAR(50),
                    origen VARCHAR(20),
                    destino VARCHAR(20),
                    cantidad INTEGER,
                    fecha TIMESTAMP DEFAULT NOW()
                );
            """)
            # 3. Usuarios (Opcional por ahora)
            cur.execute("""
                CREATE TABLE IF NOT EXISTS usuarios (
                    id SERIAL PRIMARY KEY,
                    username VARCHAR(50) UNIQUE,
                    password VARCHAR(100),
                    rol VARCHAR(20) DEFAULT 'VENDEDOR',
                    sucursal VARCHAR(20) DEFAULT 'ARAUCARIAS'
                );
            """)
            # 4. Soporte 2 Almacenes (Americas)
            try:
                cur.execute("ALTER TABLE inventario_sucursal ADD COLUMN IF NOT EXISTS stock_americas INTEGER DEFAULT 0;")
                cur.execute("ALTER TABLE inventario_sucursal ADD COLUMN IF NOT EXISTS moneda VARCHAR(10) DEFAULT 'MXN';")
                cur.execute("ALTER TABLE inventario_sucursal ADD COLUMN IF NOT EXISTS precio DECIMAL(10,2) DEFAULT 0.00;")
            except Exception as e:
                print(f"Nota mantenimiento columnas: {e}")
            
            conn.close()
            print("✅ SISTEMA CYSS: Base de Datos Actualizada (V12 Robustecida).")
        except Exception as e:
            print(f"⚠️ Alerta BD: {e}")

reparar_base_datos()

# ==========================================
# 3. FUNCIONES AUXILIARES (REDONDEO)
# ==========================================
def redondear_cyss(valor):
    """Redondea hacia arriba al múltiplo de 5 más cercano."""
    if not valor: return 0.0
    try:
        v = float(valor)
        # Ejemplo: 1021.5 -> 1025.0
        return math.ceil(v / 5) * 5
    except:
        return 0.0

def obtener_precio_web(producto_data):
    """Scraper V11 Anti-Comisión para precios Syscom"""
    # (Mantenemos tu lógica original de scraping intacta)
    modelo = producto_data.get('modelo', '')
    link_api = producto_data.get('link') 
    if link_api and link_api != "None":
        url = f"https://www.syscom.mx{link_api}" if link_api.startswith('/') else link_api
    else:
        query_segura = urllib.parse.quote(modelo)
        url = f"https://www.syscom.mx/busqueda?texto={query_segura}"
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'}
    try:
        r = requests.get(url, headers=headers, timeout=4)
        if r.status_code != 200: return 0.0
        html = r.text
        candidatos = [] 
        try:
            script_match = re.search(r'<script id="__NEXT_DATA__" type="application/json">(.*?)</script>', html)
            if script_match:
                json_data = json.loads(script_match.group(1))
                str_json = str(json_data) 
                precios_json = re.findall(r"'(?:price|specialPrice|precio|amount)':\s*'?([0-9]+\.[0-9]+)", str_json)
                for p in precios_json: candidatos.append(float(p))
        except: pass
        visuales = re.findall(r'USD(?:<[^>]+>|\s)*\$?(?:<[^>]+>|\s)*([0-9,]+\.[0-9]{2})', html)
        for p in visuales:
             try: candidatos.append(float(p.replace(',', '')))
             except: pass
        if not candidatos: return 0.0
        precios_validos = [x for x in candidatos if x > 3.0]
        if not precios_validos: precios_validos = candidatos
        return min(precios_validos)
    except: pass
    return 0.0

# ==========================================
# 4. RUTAS WEB
# ==========================================
@app.route('/')
def menu(): return render_template('menu.html')
@app.route('/cotizacion')
def cotizacion(): return render_template('index.html')
@app.route('/inventario')
def inventario(): return render_template('inventario.html')
@app.route('/material_tecnico')
def material_tecnico(): return render_template('material_tecnico.html')
@app.route('/ventas')
def ventas(): return render_template('ventas.html')
@app.route('/notas')
def notas(): return render_template('notas.html')
@app.route('/agregar_material')
def agregar_material_page(): return render_template('agregar_material.html')
# Nueva ruta para la pantalla de órdenes
@app.route('/ordenes') 
def ordenes_page(): return render_template('ordenes.html') # Requerirá crear el HTML

# ==========================================
# 5. BUSCADOR INTELIGENTE (REDONDEO + 2 ALMACENES)
# ==========================================
@app.route('/buscar_productos')
def buscar_productos():
    # Parámetros del Frontend (Buscador, TC, Margen)
    q = request.args.get('q', '').strip().upper()
    try: tc_usuario = float(request.args.get('tc', TIPO_CAMBIO_DOLAR))
    except: tc_usuario = TIPO_CAMBIO_DOLAR
    try: margen_usuario = float(request.args.get('margen', MARGEN_PUBLICO))
    except: margen_usuario = MARGEN_PUBLICO
    
    if not q: return jsonify([])
    resultados_finales = []
    
    # A. Búsqueda Local (BD)
    conn = get_db_connection()
    if conn:
        try:
            cur = conn.cursor(cursor_factory=RealDictCursor)
            # Consultamos ambos stocks y la moneda
            cur.execute("""
                SELECT modelo, nombre, precio, proveedor, 
                       stock as stock_ara, stock_americas as stock_ame,
                       COALESCE(moneda, 'MXN') as moneda 
                FROM inventario_sucursal 
                WHERE modelo ILIKE %s OR nombre ILIKE %s
            """, (f'%{q}%', f'%{q}%'))
            
            for loc in cur.fetchall():
                nombre_fmt = f"[{loc['proveedor']}] {loc['nombre']}"
                moneda = loc['moneda']
                costo_base = float(loc['precio'] or 0)
                
                # Conversión a Pesos para cálculo
                if moneda == 'USD':
                    costo_pesos = costo_base * tc_usuario
                    nombre_fmt += f" (USD {costo_base})"
                else:
                    costo_pesos = costo_base
                    nombre_fmt += " (MXN)"
                
                # Cálculo de Precio Venta con Redondeo
                precio_venta = 0
                if costo_pesos > 0:
                    precio_venta = redondear_cyss(costo_pesos / margen_usuario)

                # Formato de Stock Combinado
                st_ara = loc['stock_ara'] or 0
                st_ame = loc['stock_ame'] or 0
                stock_fmt = f"Ara:{st_ara} | Ame:{st_ame}"

                resultados_finales.append({
                    "modelo": loc['modelo'],
                    "nombre": nombre_fmt,
                    "precio_usd": costo_base, # Dato informativo
                    "precio_venta": precio_venta, # PRECIO YA REDONDEADO
                    "stock": stock_fmt,
                    "imagen_url": "/static/logo_cyss.jpg",
                    "origen": "LOCAL",
                    "moneda": moneda
                })
        except Exception as e:
            print(f"Error Local: {e}")
        finally: conn.close()

    # B. Búsqueda Syscom (Web)
    sys_res = buscar_global_syscom(q)
    if isinstance(sys_res, list):
        for p in sys_res[:5]:
            precio_web = obtener_precio_web(p)
            # Lógica para encontrar el mejor precio API
            precio_api = 0.0
            try:
                vals = []
                for k in ['precio_1', 'precio_especial', 'precio_descuento', 'precio_lista']:
                    v = p.get(k)
                    if v: 
                        try: vals.append(float(str(v).replace(',','')))
                        except: pass
                if p.get('precios'):
                    for k,v in p.get('precios').items():
                        try: vals.append(float(str(v).replace(',','')))
                        except: pass
                if vals: precio_api = min([x for x in vals if x > 0])
            except: pass
            
            # Costo Referencia (USD usualmente)
            costo_ref = precio_web if precio_web > 0 else (round(precio_api * 0.96, 2) if precio_api > 0 else 0)
            
            # Calcular Precio Venta Sugerido (Convertido y Redondeado)
            precio_venta_sys = 0
            if costo_ref > 0:
                costo_pesos_sys = costo_ref * tc_usuario
                precio_venta_sys = redondear_cyss(costo_pesos_sys / margen_usuario)

            resultados_finales.append({
                "modelo": p.get('modelo'),
                "nombre": p.get('titulo') + " (Web)",
                "precio_usd": costo_ref,
                "precio_venta": precio_venta_sys,
                "stock": "Web",
                "imagen_url": p.get('img_portada') or "https://via.placeholder.com/40",
                "origen": "SYSCOM",
                "moneda": "USD"
            })
            
    return jsonify(resultados_finales)

# ==========================================
# 6. APIs: GESTIÓN Y TRANSFERENCIAS
# ==========================================
@app.route('/api/obtener_inventario')
def api_obtener_inventario():
    conn = get_db_connection()
    if not conn: return jsonify([])
    cur = conn.cursor(cursor_factory=RealDictCursor)
    try:
        # Traemos ambas columnas de stock
        cur.execute("""
            SELECT id, modelo, nombre, stock as stock_araucarias, stock_americas, 
                   precio, moneda 
            FROM inventario_sucursal ORDER BY modelo ASC
        """)
        filas = cur.fetchall()
        data = []
        for f in filas:
            costo = float(f['precio'] or 0)
            # Precio venta estimado (público)
            if f.get('moneda') == 'USD':
                costo_mxn = costo * TIPO_CAMBIO_DOLAR
            else:
                costo_mxn = costo
            
            data.append({
                'id': f['id'], 'modelo': f['modelo'], 'nombre': f['nombre'],
                'stock': f['stock_araucarias'], # Compatible con frontend viejo
                'stock_americas': f.get('stock_americas', 0), # Dato nuevo
                'precio_venta': redondear_cyss(costo_mxn / MARGEN_PUBLICO),
                'moneda': f.get('moneda', 'MXN')
            })
        return jsonify(data)
    finally: conn.close()

@app.route('/api/actualizar_precio_rapido', methods=['POST'])
def actualizar_precio_rapido():
    """Permite actualizar el precio base desde el cotizador"""
    data = request.json
    modelo = data.get('modelo')
    # El usuario manda el precio de VENTA final (ej. 1025)
    precio_venta_nuevo = float(data.get('precio_venta'))
    
    # Calculamos hacia atrás el COSTO base aproximado
    nuevo_costo = precio_venta_nuevo * MARGEN_PUBLICO
    
    conn = get_db_connection()
    try:
        cur = conn.cursor()
        cur.execute("UPDATE inventario_sucursal SET precio = %s WHERE modelo = %s", (nuevo_costo, modelo))
        conn.commit()
        return jsonify({'status': 'success'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)})
    finally: conn.close()

@app.route('/api/transferir', methods=['POST'])
def transferir_mercancia():
    d = request.json
    modelo = d['modelo']
    origen = d['origen'] # 'ARAUCARIAS' o 'AMERICAS'
    cantidad = int(d['cantidad'])
    
    col_origen = 'stock_americas' if origen == 'AMERICAS' else 'stock'
    col_destino = 'stock' if origen == 'AMERICAS' else 'stock_americas'
    
    conn = get_db_connection()
    try:
        cur = conn.cursor()
        # Verificar stock
        cur.execute(f"SELECT {col_origen} FROM inventario_sucursal WHERE modelo = %s", (modelo,))
        res = cur.fetchone()
        if not res or res[0] < cantidad:
            return jsonify({'status': 'error', 'message': 'Stock insuficiente'})
            
        # Mover
        cur.execute(f"UPDATE inventario_sucursal SET {col_origen} = {col_origen} - %s WHERE modelo = %s", (cantidad, modelo))
        cur.execute(f"UPDATE inventario_sucursal SET {col_destino} = {col_destino} + %s WHERE modelo = %s", (cantidad, modelo))
        
        # Historial
        cur.execute("INSERT INTO transferencias (modelo, origen, destino, cantidad) VALUES (%s, %s, %s, %s)",
                    (modelo, origen, "OTRO", cantidad))
        conn.commit()
        return jsonify({'status': 'success'})
    except Exception as e:
        conn.rollback()
        return jsonify({'status': 'error', 'message': str(e)})
    finally: conn.close()

# Mantener las rutas de creación manual y movimientos (Sin cambios mayores)
@app.route('/api/crear_producto_manual', methods=['POST'])
def crear_producto_manual():
    d = request.json
    conn = get_db_connection()
    cur = conn.cursor()
    try:
        modelo = d.get('modelo', '').strip().upper()
        if not modelo: return jsonify({'status': 'error'})
        cur.execute("""INSERT INTO inventario_sucursal (modelo, nombre, proveedor, stock, precio, moneda)
            VALUES (%s, %s, %s, %s, %s, %s)""", 
            (modelo, d.get('nombre','').upper(), d.get('proveedor','GENERICO'), d.get('stock',0), d.get('precio',0), d.get('moneda','MXN')))
        conn.commit()
        return jsonify({'status': 'success'})
    except Exception as e: return jsonify({'status': 'error', 'message': str(e)})
    finally: conn.close()

# ==========================================
# 7. APIs: ÓRDENES DE TRABAJO (NUEVO)
# ==========================================
@app.route('/api/ordenes', methods=['GET', 'POST'])
def api_ordenes():
    conn = get_db_connection()
    cur = conn.cursor(cursor_factory=RealDictCursor)
    if request.method == 'GET':
        cur.execute("SELECT * FROM ordenes_trabajo ORDER BY folio DESC LIMIT 50")
        data = cur.fetchall()
        conn.close()
        return jsonify(data)
    if request.method == 'POST':
        d = request.json
        cur.execute("""
            INSERT INTO ordenes_trabajo (cliente, equipo, falla_reportada, estado)
            VALUES (%s, %s, %s, 'RECIBIDO')
        """, (d.get('cliente'), d.get('equipo'), d.get('falla')))
        conn.commit()
        conn.close()
        return jsonify({'status': 'success'})

# Rutas viejas de técnicos (se mantienen por compatibilidad)
@app.route('/api/tecnicos/guardar_salida', methods=['POST'])
def guardar_salida_tecnico():
    # ... (código original intacto) ...
    return jsonify({'status': 'success'}) # Simplificado aquí para brevedad, en tu código real deja el original.

# ==========================================
# 8. EXPORTAR PDF (LOCAL + RED)
# ==========================================
class PDF(FPDF):
    def footer(self):
        self.set_y(-20)
        self.set_font('Arial', '', 8)
        self.set_text_color(0, 0, 0)
        self.cell(0, 5, "Av. Araucarias 262 Fracc.Indeco Animas. Tel: (228) 690-7449 | www.cyssxalapa.com.mx", 0, 1, 'C')

@app.route('/api/exportar_pdf', methods=['POST'])
def exportar_pdf():
    try:
        data = request.json
        cliente = data.get('cliente', 'CLIENTE').upper()
        items = data.get('items', [])
        total_str = data.get('total', '0')
        
        # ... (Tu lógica de generación de PDF igual que antes) ...
        pdf = PDF()
        pdf.add_page()
        # [AQUÍ VA TODO TU CÓDIGO DE DIBUJADO DE PDF, LO OMITO PARA NO HACERLO ETERNO, PERO LO MANTIENES IGUAL]
        # Solo agrego el header y una línea de ejemplo para que compile
        pdf.set_font('Arial', 'B', 16)
        pdf.cell(0, 10, f'COTIZACION: {cliente}', 0, 1, 'C')
        
        # --- NUEVA LÓGICA DE GUARDADO ---
        nombre_archivo = f"Cotizacion_{cliente[:10].replace(' ','_')}.pdf"
        
        # 1. Guardar Local
        if not os.path.exists('static'): os.makedirs('static')
        ruta_local = os.path.join('static', nombre_archivo)
        pdf.output(ruta_local)
        
        # 2. Guardar en RED
        try:
            if not os.path.exists(RUTA_RED_DOCKER):
                os.makedirs(RUTA_RED_DOCKER, exist_ok=True)
            ruta_red = os.path.join(RUTA_RED_DOCKER, nombre_archivo)
            pdf.output(ruta_red)
            print(f"✅ Guardado en Red: {ruta_red}")
        except Exception as e:
            print(f"⚠️ Error Red: {e}")

        return jsonify({'status': 'success', 'archivo': f'/static/{nombre_archivo}'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)})

# ==========================================
# 9. INICIO
# ==========================================
if __name__ == '__main__':
    if not os.path.exists('static'): os.makedirs('static')
    print("--- SISTEMA CYSS: LISTO (DOCKER/LOCAL) ---")
    app.run(host='0.0.0.0', port=5000, debug=False)