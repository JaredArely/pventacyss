{% extends "base.html" %}

{% block title %}Almac茅n | CYSS{% endblock %}

{% block head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6 !important; }
        .card-cyss { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card-cyss:hover { transform: translateY(-4px); }
    </style>
{% endblock %}

{% block content %}
<div class="bg-white shadow-sm rounded-lg p-4 mb-4 border border-gray-200">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
        <div>
            <h2 class="text-2xl font-extrabold text-blue-900 tracking-tight"> Inventario de Sucursales</h2>
            <p class="text-gray-500 text-sm font-medium">Gesti贸n de Stock y Simulador de Precios</p>
        </div>
        
        <div class="flex gap-2">
            <button onclick="exportarPDF()" class="btn btn-danger rounded-pill px-4 shadow-sm">
                <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
            <a href="/historial_movimientos" class="btn btn-outline-secondary rounded-pill shadow-sm">
                <i class="fas fa-history me-1"></i> Historial
            </a>
            {% if session['rol'] in ['admin', 'operador'] %}
            <button onclick="abrirModalNuevo()" class="btn btn-primary rounded-pill px-4 shadow-sm font-bold">
                <i class="fas fa-plus me-1"></i> Nuevo Producto
            </button>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 border-top pt-3">
        <div class="col-md-5">
            <label class="form-label small fw-bold text-gray-500 uppercase tracking-wider">Buscador</label>
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0 text-gray-400"><i class="fas fa-search"></i></span>
                <input type="text" id="busqueda" class="form-control border-start-0 ps-0" 
                       placeholder="Escribe modelo o descripci贸n..." onkeyup="cargar()">
            </div>
        </div>
        <div class="col-md-4">
            <label class="form-label small fw-bold text-gray-500 uppercase tracking-wider">Categor铆a</label>
            <select id="filtro_categoria" class="form-select shadow-sm text-gray-700 font-medium" onchange="cargar()">
                <option value="TODAS">--- Todas las Categor铆as ---</option>
                <option value="CCTV">CCTV</option>
                <option value="ALARMA">ALARMAS</option>
                <option value="REDES">REDES</option>
                <option value="GENERAL">GENERAL / VARIOS</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small fw-bold text-emerald-600 uppercase tracking-wider">
                <i class="fas fa-dollar-sign"></i> Simulador D贸lar
            </label>
            <select id="tipo_cambio" class="form-select shadow-sm text-emerald-800 font-bold border-emerald-200 bg-emerald-50" onchange="cargar()">
                <option value="18.00">D贸lar a $18.00</option>
                <option value="18.50">D贸lar a $18.50</option>
                <option value="19.00" selected>D贸lar a $19.00</option>
                <option value="20.00">D贸lar a $20.00</option>
            </select>
        </div>
    </div>
</div>

<div id="contenedor-productos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-5">
    </div>

<div class="modal fade" id="modalProducto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gray-900 text-white">
                <h5 class="modal-title font-bold" id="tituloModal">Editar Producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-gray-50">
                <input type="hidden" id="form_id">
                <div class="mb-3">
                    <label class="form-label fw-bold text-gray-700">Modelo</label>
                    <input type="text" id="form_modelo" class="form-control shadow-sm">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold text-gray-700">Descripci贸n</label>
                    <textarea id="form_nombre" class="form-control shadow-sm" rows="2"></textarea>
                </div>
                <div class="card p-3 border-0 bg-white shadow-sm mb-3">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label fw-bold text-success">Stock Araucarias</label>
                            <input type="number" id="form_arau" class="form-control text-center font-bold text-success border-success">
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold text-primary">Stock Am茅ricas</label>
                            <input type="number" id="form_ame" class="form-control text-center font-bold text-primary border-primary">
                        </div>
                    </div>
                </div>
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle"></i> Aqu铆 editas el <b>Costo Base de Compra</b>.
                </div>
                <div class="mb-1">
                    <label class="form-label fw-bold text-gray-700">Costo Base (Sin IVA)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-gray-200 fw-bold">$</span>
                        <input type="number" id="form_precio" class="form-control font-bold text-gray-800" step="0.01">
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-gray-50 border-top-0">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary rounded-pill px-4 font-bold" onclick="guardar()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<script>
    const username = "{{ session['username'] }}";
    const esMario = (username === 'MARIO');
    let modalEdicion; 
    let productosGlobal = [];

    document.addEventListener('DOMContentLoaded', function() {
        modalEdicion = new bootstrap.Modal(document.getElementById('modalProducto'));
        cargar(); 
    });

    function abrirModalNuevo() { window.location.href = '/agregar_material'; }
    
    function obtenerColorStock(cantidad) {
        const num = parseInt(cantidad) || 0;
        if (num > 5) return 'bg-green-100 text-green-800 border border-green-200';
        if (num > 0) return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        return 'bg-red-100 text-red-800 border border-red-200';
    }

    async function cargar() {
    try {
        const q = document.getElementById('busqueda').value;
        const cat = document.getElementById('filtro_categoria').value;
        const tipoCambio = parseFloat(document.getElementById('tipo_cambio').value) || 18.0;
        
        const res = await fetch(`/api/inventario/obtener?q=${q}&cat=${cat}`);
        const data = await res.json();
        
        productosGlobal = data;
        const contenedor = document.getElementById('contenedor-productos');
        
        if (data.length === 0) {
            contenedor.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No se encontraron productos.</div>';
            return;
        }

        const redondear5 = (v) => Math.ceil(v / 5) * 5;

        contenedor.innerHTML = data.map((p, index) => {
            let categoriaLimpia = (!p.categoria || p.categoria === 'nan' || p.categoria === 'null') ? 'GENERAL' : p.categoria;
            let costoBase = parseFloat(p.precio) || 0;
            let moneda = (p.moneda || 'MXN').toUpperCase(); 
            let costoEnPesos = (moneda === 'USD') ? (costoBase * tipoCambio) : costoBase;
            let costoConIVA = costoEnPesos * 1.16;

            const precioPublico = redondear5(costoConIVA / 0.75);
            const precioPreferente = redondear5(costoConIVA / 0.80);
            const precioIntegrador = redondear5(costoConIVA / 0.90);

            const fmt = (v) => v.toLocaleString('es-MX', {style: 'currency', currency: 'MXN'});

            return `
            <div class="card-cyss shadow-sm p-4 bg-white border border-gray-200 rounded-xl flex flex-col h-full hover:shadow-lg">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1 min-w-0">
                        <span class="inline-block px-2 py-0.5 text-[10px] font-bold rounded bg-blue-50 text-blue-700 border border-blue-100 mb-2">
                            ${categoriaLimpia}
                        </span>
                        <h3 class="text-lg font-extrabold text-blue-900 truncate">${p.modelo}</h3>
                        <p class="text-xs text-gray-500 truncate">${p.nombre}</p>
                        <span class="text-[9px] font-bold text-gray-400 bg-gray-100 px-1 rounded">
                            Costo orig: ${costoBase} ${moneda}
                        </span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-2 border border-gray-100 my-3">
                    <div class="flex justify-between items-center mb-1 border-b pb-1">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">P煤blico (0.75)</span>
                        <span class="text-sm font-black text-emerald-700">${fmt(precioPublico)}</span>
                    </div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">Preferente (0.80)</span>
                        <span class="text-xs font-bold text-blue-700">${fmt(precioPreferente)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">Integrador (0.90)</span>
                        <span class="text-xs font-bold text-purple-700">${fmt(precioIntegrador)}</span>
                    </div>
                </div>

                <div class="mt-auto pt-3 flex gap-2 border-t border-gray-100">
                    {% if session['rol'] in ['admin', 'operador'] %}
                    <button onclick="editar(${index})" 
                            class="flex-1 bg-blue-50 text-blue-700 text-xs font-bold py-2 rounded-lg hover:bg-blue-100 transition-colors">
                        <i class="fas fa-edit me-1"></i> Editar
                    </button>
                    <button onclick="eliminarProducto(${p.id})" 
                            class="px-3 bg-red-50 text-red-600 text-xs py-2 rounded-lg hover:bg-red-100 transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    {% endif %}
                </div>
            </div>`;
        }).join('');
    } catch (error) {
        console.error("Error cargando inventario:", error);
    }
}

    function editar(index) {
        const p = productosGlobal[index];
        document.getElementById('form_id').value = p.id;
        document.getElementById('form_modelo').value = p.modelo;
        document.getElementById('form_nombre').value = p.nombre;
        document.getElementById('form_precio').value = p.precio; // Cargamos COSTO base
        
        const inAra = document.getElementById('form_arau');
        const inAme = document.getElementById('form_ame');
        const inPre = document.getElementById('form_precio');

        if (esMario) {
            inAra.readOnly = true; inAra.classList.add('bg-light');
            inAme.readOnly = false; inAme.classList.remove('bg-light');
            inPre.readOnly = true;
        } else {
            inAra.readOnly = false; inAme.readOnly = false; inPre.readOnly = false;
            inAra.classList.remove('bg-light'); inAme.classList.remove('bg-light');
        }

        inAra.value = p.stock_arau;
        inAme.value = p.stock_ame;
        modalEdicion.show();
    }

    async function guardar() {
        const datos = {
            id: document.getElementById('form_id').value, 
            modelo: document.getElementById('form_modelo').value,
            nombre: document.getElementById('form_nombre').value,
            stock_arau: document.getElementById('form_arau').value,
            stock_ame: document.getElementById('form_ame').value,
            precio: document.getElementById('form_precio').value // Guardamos costo
        };
        
        try {
            const response = await fetch('/api/inventario/actualizar', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(datos) 
            });
            const res = await response.json();
            if(res.status === 'success') { modalEdicion.hide(); cargar(); }
            else { alert("Error: " + res.message); }
        } catch (error) { alert("Error de conexi贸n."); }
    }

    async function exportarPDF() {
        const q = document.getElementById('busqueda').value;
        const cat = document.getElementById('filtro_categoria').value;
        const res = await fetch(`/api/inventario/exportar_pdf?q=${q}&cat=${cat}`);
        const data = await res.json();
        if(data.status === 'success') window.open(data.url, '_blank');
    }
</script>
{% endblock %}